pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command:
        - /busybox/cat
      tty: true
      volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
  volumes:
    - name: docker-config
      emptyDir: {}
"""
        }
    }

    parameters {
        credentials(
            name: 'DOCKER_CREDENTIALS',
            description: 'Docker registry credentials',
            credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',
            defaultValue: '',
            required: true
        )

        credentials(
            name: 'GIT_CREDENTIALS',
            description: 'Git credentials',
            credentialType: 'com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl',
            defaultValue: '',
            required: true
        )
    }

    stages {
        stage('Checkout Config Repo') {
            steps {
                git branch: 'main',
                    credentialsId: params.GIT_CREDENTIALS,
                    url: "https://github.com/KHDevOps/eks-scalable-devops-platform"
            }
        }

        stage('Build & Push Image') {
            steps {
                script {
                    def config = readYaml file: 'templates/app-config.yaml'
                    def source_repo     = config.git.source_repo
                    def app_name        = config.app.name
                    def version         = config.app.version
                    def docker_username = config.docker.username

                    dir('source-code') {
                        git branch: 'main',
                            credentialsId: params.GIT_CREDENTIALS,
                            url: "https://${source_repo}"

                        withCredentials([usernamePassword(credentialsId: params.DOCKER_CREDENTIALS,
                                                          usernameVariable: 'DOCKER_USER',
                                                          passwordVariable: 'DOCKER_PASS')]) {
                            container('kaniko') {
                                sh """
                                  mkdir -p /kaniko/.docker
                                  cat > /kaniko/.docker/config.json <<EOF
                                  {
                                    "auths": {
                                      "https://index.docker.io/v1/": {
                                        "username": "${DOCKER_USER}",
                                        "password": "${DOCKER_PASS}"
                                      }
                                    }
                                  }
EOF
                                  /kaniko/executor \
                                    --context `pwd` \
                                    --dockerfile Dockerfile \
                                    --destination ${docker_username}/${app_name}:${version} \
                                    --destination ${docker_username}/${app_name}:latest
                                """
                            }
                        }
                    }
                }
            }
        }
    }
}